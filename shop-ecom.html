<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Shop — Gems of Nature (Ecommerce)</title>
  <meta name="description" content="Buy natural gemstones & healing crystals — Gems of Nature. Secure checkout, COD & online payment (simulated)." />

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    .font-montserrat { font-family: 'Montserrat', sans-serif; }

    /* Fade-in animation */
    .fade-in {
      opacity: 0;
      transform: translateY(20px);
      animation: fadeInUp 0.8s ease forwards;
    }
    @keyframes fadeInUp {
      to { opacity: 1; transform: translateY(0); }
    }

    /* product detail slide-in */
    .detail-panel { transition: transform .28s ease, opacity .28s ease; transform: translateX(20px); opacity: 0; }
    .detail-panel.open { transform: translateX(0); opacity: 1; }

    /* hover overlay */
    .product-card { position: relative; overflow: hidden; }
    .product-overlay {
      position: absolute; inset: 0; display:flex; align-items:flex-end; justify-content:center;
      background: linear-gradient(180deg, rgba(0,0,0,0) 40%, rgba(0,0,0,0.55) 100%);
      color: white; padding: 1rem; transform: translateY(100%); transition: transform .25s ease;
    }
    .product-card:hover .product-overlay, .product-card:focus-within .product-overlay { transform: translateY(0); }

    /* small utility for truncated text */
    .line-clamp-3 { overflow:hidden; display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; }

    .muted { color:#6b7280; font-size:0.95rem; }
  </style>
</head>

<body class="bg-gray-50 text-gray-800 font-montserrat" data-page="shop-ecom">
  <!-- Shared header (injected by layout.js) -->
  <div id="header"></div>

  <!-- HERO -->
  <section class="relative bg-cover bg-center h-52 md:h-64 fade-in" style="background-image:url('images/hero-bg.jpg')">
    <div class="absolute inset-0 bg-black/45 flex items-center justify-center">
      <div class="text-center text-white px-6">
        <h1 class="text-2xl md:text-4xl font-bold">Shop & Buy — Gems of Nature</h1>
        <p class="mt-2">Authentic gemstones for healing, jewellery & collectors.</p>
      </div>
    </div>
  </section>

  <!-- MAIN -->
  <main class="container mx-auto px-4 py-10 fade-in">
    <div class="lg:flex lg:gap-8">

      <!-- LEFT: Filters + Grid -->
      <div class="flex-1">
        <!-- Filters bar -->
        <div class="bg-white rounded-2xl shadow p-4 mb-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
          <div class="flex items-center gap-3">
            <input id="search-input" type="search" placeholder="Search stones, rudraksha or qualities" class="border rounded px-3 py-2 w-72" />

            <select id="category-filter" class="border rounded px-2 py-2 text-sm">
              <option value="all">All categories</option>
              <option value="Precious">Precious</option>
              <option value="Semi-Precious">Semi-Precious</option>
              <option value="Healing">Healing</option>
              <option value="Rudraksha">Rudraksha</option>
              <option value="Raw Stones">Raw Stones</option>
            </select>

            <select id="sort-select" class="border rounded px-2 py-2 text-sm">
              <option value="default">Sort: Featured</option>
              <option value="price-asc">Price: Low → High</option>
              <option value="price-desc">Price: High → Low</option>
            </select>
          </div>

          <div class="flex items-center gap-3">
            <label class="text-sm text-gray-600">Currency</label>
            <select id="currency-select" class="border rounded px-2 py-1 text-sm">
              <option value="INR">₹ INR</option>
              <option value="USD">$ USD</option>
              <option value="EUR">€ EUR</option>
              <option value="GBP">£ GBP</option>
            </select>
          </div>
        </div>

        <!-- Products grid -->
        <div id="products-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-3 gap-6"></div>

        <!-- pagination -->
        <div id="pagination" class="mt-6 flex items-center justify-center gap-2"></div>
      </div>

      <!-- RIGHT: Cart -->
      <aside id="cart-sidebar" class="w-full lg:w-96 bg-white rounded-2xl shadow-md p-6 mt-6 lg:mt-0">
        <h3 class="text-xl font-semibold text-emerald-700">
          Your Cart <span id="cart-count" class="ml-2 inline-block bg-emerald-100 text-emerald-700 text-sm px-2 py-0.5 rounded">0</span>
        </h3>
        <div id="cart-items" class="mt-4 space-y-4 max-h-72 overflow-auto">
          <!-- cart items injected here -->
        </div>

        <div class="mt-4 border-t pt-4">
          <div class="flex justify-between text-gray-700">
            <span class="font-medium">Subtotal</span>
            <span id="cart-subtotal">₹0</span>
          </div>
          <div class="flex justify-between text-gray-700 mt-2">
            <span class="font-medium">Shipping</span>
            <span id="cart-shipping">₹50</span>
          </div>
          <div class="flex justify-between text-lg font-semibold text-emerald-800 mt-3">
            <span>Total</span>
            <span id="cart-total">₹0</span>
          </div>

          <button id="checkout-button" class="mt-4 w-full bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg">Checkout</button>
          <button id="clear-cart" class="mt-3 w-full border border-gray-200 text-gray-700 px-4 py-2 rounded-lg">Clear Cart</button>
        </div>
      </aside>
    </div>
  </main>

  <!-- PRODUCT DETAIL (slides in) -->
  <aside id="product-detail" class="fixed right-4 top-12 w-full md:w-1/2 bg-white rounded-2xl shadow-lg p-6 detail-panel z-50 hidden" aria-hidden="true">
    <div class="flex gap-4">
      <img id="detail-image" src="images/placeholder.jpg" alt="" class="w-40 h-40 object-cover rounded" />
      <div class="flex-1">
        <div class="flex items-start justify-between">
          <h3 id="detail-title" class="text-xl font-semibold text-emerald-700"></h3>
          <button id="close-detail" class="text-gray-500">✕</button>
        </div>
        <div id="detail-meta" class="text-sm text-gray-600 mt-2"></div>
        <div id="detail-desc" class="text-sm text-gray-700 mt-3"></div>
        <div id="detail-mukhi" class="mt-3 text-sm text-gray-700"></div>
        <div id="detail-deity" class="mt-1 text-sm text-gray-700"></div>
        <div id="detail-mantra" class="mt-1 text-sm text-gray-700"></div>
        <div class="mt-4 flex items-center gap-3">
          <div id="detail-price" class="text-lg font-semibold text-emerald-800"></div>
          <button id="detail-add" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg">Add to Cart</button>
        </div>
      </div>
    </div>
  </aside>

  <!-- Shared footer (injected by layout.js) -->
  <div id="footer"></div>

  <!-- Shared layout (header + footer) -->
  <script src="js/layout.js"></script>

  <!-- shared product data -->
  <script src="js/products.js"></script>

  <!-- Main ecommerce logic -->
  <script>
  // compute a display price (midpoint) for each product if not present
  products.forEach(p => { if (!p.price) p.price = Math.round(((p.price_min || 0) + (p.price_max || 0)) / 2); });

  const ITEMS_PER_PAGE = 12; // 3 columns × 4 rows per page
  let currentPage = 1;
  let currentCurrency = 'INR';
  const currencyRates = { INR:1, USD:1/83, EUR:1/95, GBP:1/110 };
  let cart = JSON.parse(localStorage.getItem('gon_cart') || '{}');
  const SHIPPING = 50;

  function formatCurrency(value, currency='INR'){
    if (value==null) return '';
    if (currency==='INR') return '₹'+Number(value).toLocaleString('en-IN');
    return (currency==='USD'? '$': currency==='EUR'? '€': '£') + (value*currencyRates[currency]).toFixed(2);
  }

  // Helper: pick a usable price for any product
  function getProductPrice(prod) {
    if (!prod) return 0;
    if (typeof prod.price === 'number') return prod.price;
    if (typeof prod.price_min === 'number') return prod.price_min;
    if (typeof prod.price_max === 'number') return prod.price_max;
    const raw = String(prod.price || prod.price_min || prod.price_max || '');
    const num = parseFloat(raw.replace(/[^0-9.-]/g, ''));
    return isNaN(num) ? 0 : num;
  }

  function renderProductCard(p){
    const div = document.createElement('div');
    div.className = 'bg-white rounded-2xl shadow-md product-card';
    div.setAttribute('data-id', p.id);
    div.innerHTML = `
      <div class="relative h-48">
        <img src="${p.image}" onerror="this.src='images/placeholder.jpg'" alt="${p.name}" class="w-full h-full object-cover transition-transform duration-500" />
        <div class="product-overlay">
          <div class="w-full text-sm text-white line-clamp-3">${p.description || ''}</div>
        </div>
      </div>
      <div class="p-4">
        <h4 class="text-md font-semibold text-emerald-700">${p.name}</h4>
        <div class="text-xs text-gray-600">${p.category || ''}</div>
        <div class="mt-3 flex items-center justify-between">
          <div class="font-semibold text-gray-800">${formatCurrency(getProductPrice(p), currentCurrency)}</div>
          <div class="flex items-center gap-2">
            <button class="view-detail bg-white border border-gray-200 text-gray-700 px-3 py-2 rounded-lg" data-id="${p.id}">View</button>
            <button
              class="add-to-cart bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-2 rounded-lg"
              data-id="${p.id}"
            >
              Add
            </button>
          </div>
        </div>
      </div>
    `;
    return div;
  }

  function applyFilters(){
    const q = (document.getElementById('search-input').value || '').toLowerCase();
    const cat = document.getElementById('category-filter').value;
    const sort = document.getElementById('sort-select').value;
    let out = products.filter(p => {
      if (cat!=='all' && p.category!==cat) return false;
      if (q && !(p.name.toLowerCase().includes(q) || (p.description||'').toLowerCase().includes(q) || (p.category||'').toLowerCase().includes(q))) return false;
      return true;
    });
    if (sort==='price-asc') out.sort((a,b)=>getProductPrice(a)-getProductPrice(b));
    if (sort==='price-desc') out.sort((a,b)=>getProductPrice(b)-getProductPrice(a));
    return out;
  }

  function renderPagination(pages){
    const el = document.getElementById('pagination');
    el.innerHTML = '';
    if (pages<=1) return;
    for(let i=1;i<=pages;i++){
      const btn = document.createElement('button');
      btn.className = `px-3 py-1 rounded ${i===currentPage? 'bg-emerald-600 text-white' : 'bg-white border'}`;
      btn.textContent = i;
      btn.onclick = ()=>{ currentPage=i; renderProducts(); window.scrollTo({top:200,behavior:'smooth'}); };
      el.appendChild(btn);
    }
  }

  function renderProducts(){
    const grid = document.getElementById('products-grid');
    grid.innerHTML = '';
    const filtered = applyFilters();
    const start = (currentPage-1)*ITEMS_PER_PAGE;
    const pageItems = filtered.slice(start, start+ITEMS_PER_PAGE);
    pageItems.forEach(p=> grid.appendChild(renderProductCard(p)));
    renderPagination(Math.ceil(filtered.length/ITEMS_PER_PAGE));
  }

  // product card interactions
  document.getElementById('products-grid').addEventListener('click',(e)=>{
    if (e.target.closest('.add-to-cart')){
      const id = e.target.closest('[data-id]').getAttribute('data-id');
      cart[id] = (cart[id]||0)+1;
      saveCart();
      e.target.textContent = 'Added';
      setTimeout(()=> e.target.textContent='Add',800);
    } else if (e.target.closest('.view-detail')){
      const id = e.target.closest('[data-id]').getAttribute('data-id');
      openProductDetail(id);
    } else {
      const card = e.target.closest('[data-id]');
      if (card) openProductDetail(card.getAttribute('data-id'));
    }
  });

  // detail panel
  const detailPanel = document.getElementById('product-detail');
  const detailImage = document.getElementById('detail-image');
  const detailTitle = document.getElementById('detail-title');
  const detailMeta = document.getElementById('detail-meta');
  const detailDesc = document.getElementById('detail-desc');
  const detailMukhi = document.getElementById('detail-mukhi');
  const detailDeity = document.getElementById('detail-deity');
  const detailMantra = document.getElementById('detail-mantra');
  const detailPrice = document.getElementById('detail-price');
  const detailAdd = document.getElementById('detail-add');

  function openProductDetail(id){
    const p = products.find(x=>String(x.id)===String(id));
    if(!p) return;
    detailImage.src = p.image||'images/placeholder.jpg';
    detailTitle.textContent = p.name;
    detailMeta.textContent = p.category||'';
    detailDesc.textContent = p.description||'';
    detailMukhi.textContent = p.mukhi? ('Mukhi: '+p.mukhi) : '';
    detailDeity.textContent = p.deity? ('Deity: '+p.deity) : '';
    detailMantra.textContent = p.mantra? ('Mantra: '+p.mantra) : '';
    detailPrice.textContent = formatCurrency(getProductPrice(p), currentCurrency);
    detailAdd.dataset.id = p.id;
    detailPanel.classList.remove('hidden');
    setTimeout(()=> detailPanel.classList.add('open'),10);
    detailPanel.setAttribute('aria-hidden','false');
  }

  document.getElementById('close-detail').addEventListener('click', ()=>{
    detailPanel.classList.remove('open');
    setTimeout(()=> detailPanel.classList.add('hidden'),280);
  });

  detailAdd && detailAdd.addEventListener('click', ()=>{
    const id=detailAdd.dataset.id;
    cart[id]=(cart[id]||0)+1;
    saveCart();
    detailAdd.textContent='Added';
    setTimeout(()=> detailAdd.textContent='Add to Cart',900);
  });

  // cart functions
  const cartItemsEl = document.getElementById('cart-items');
  const cartCountEl = document.getElementById('cart-count');
  const cartSubtotalEl = document.getElementById('cart-subtotal');
  const cartShippingEl = document.getElementById('cart-shipping');
  const cartTotalEl = document.getElementById('cart-total');
  const checkoutBtn = document.getElementById('checkout-button');
  const clearCartBtn = document.getElementById('clear-cart');

  // Update header badge (red circle in navbar)
  function updateHeaderCartCount(count) {
    const badge = document.getElementById('cartCount'); // span in header.html
    if (!badge) return;
    badge.textContent = String(count);
  }

  function saveCart(){
    localStorage.setItem('gon_cart', JSON.stringify(cart));
    renderCart();
  }

  function renderCart(){
    cartItemsEl.innerHTML = '';
    const entries = Object.entries(cart || {});
    let subtotal = 0;

    if (entries.length === 0) {
      cartItemsEl.innerHTML = '<p class="text-gray-600">Your cart is empty.</p>';
      cartCountEl.textContent = '0';
      updateHeaderCartCount(0);
    } else {
      entries.forEach(([pid, qty]) => {
        const prod =
          products.find(p => String(p.id) === String(pid)) ||
          { name: pid, price: 0, image: 'images/placeholder.jpg' };

        const price = getProductPrice(prod);
        subtotal += price * qty;

        const item = document.createElement('div');
        item.className = 'flex items-center gap-3 py-2';
        item.innerHTML = `
          <div class="h-14 w-14 flex-shrink-0">
            <img src="${prod.image || 'images/placeholder.jpg'}"
                 onerror="this.src='images/placeholder.jpg'"
                 class="h-14 w-14 object-cover rounded"/>
          </div>
          <div class="flex-1">
            <div class="text-sm font-medium">${prod.name || pid}</div>
            <div class="text-xs text-gray-500">
              ${formatCurrency(price, currentCurrency)} ×
              <span class="qty-num" data-id="${pid}">${qty}</span>
            </div>
            <div class="mt-1 flex items-center gap-2">
              <button class="decrease text-sm px-2 py-1 border rounded" data-id="${pid}" aria-label="Decrease quantity">-</button>
              <button class="increase text-sm px-2 py-1 border rounded" data-id="${pid}" aria-label="Increase quantity">+</button>
              <button class="remove ml-3 text-xs text-red-600" data-id="${pid}" aria-label="Remove item">Remove</button>
            </div>
          </div>
          <div class="text-sm font-semibold">
            ${formatCurrency(price * qty, currentCurrency)}
          </div>
        `;
        cartItemsEl.appendChild(item);
      });

      const count = entries.reduce((s, [, q]) => s + Number(q || 0), 0);
      cartCountEl.textContent = String(count);
      updateHeaderCartCount(count);
    }

    cartSubtotalEl.textContent = formatCurrency(subtotal, currentCurrency);
    cartShippingEl.textContent = entries.length ? formatCurrency(SHIPPING, currentCurrency) : formatCurrency(0, currentCurrency);
    cartTotalEl.textContent = formatCurrency(entries.length ? subtotal + SHIPPING : 0, currentCurrency);

    // attach handlers (re-bind each render)
    document.querySelectorAll('.increase').forEach(btn => {
      btn.onclick = () => {
        const id = btn.dataset.id;
        cart[id] = (cart[id] || 0) + 1;
        saveCart();
      };
    });

    document.querySelectorAll('.decrease').forEach(btn => {
      btn.onclick = () => {
        const id = btn.dataset.id;
        cart[id] = Math.max(0, (cart[id] || 0) - 1);
        if (cart[id] === 0) delete cart[id];
        saveCart();
      };
    });

    document.querySelectorAll('.remove').forEach(btn => {
      btn.onclick = () => {
        const id = btn.dataset.id;
        delete cart[id];
        saveCart();
      };
    });
  }

  // search / filter events
  ['search-input','category-filter','sort-select'].forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener('input', () => { currentPage = 1; renderProducts(); });
  });

  // currency change
  const currencySelectEl = document.getElementById('currency-select');
  if (currencySelectEl) {
    currencySelectEl.addEventListener('change', (e) => {
      currentCurrency = e.target.value;
      renderProducts();
      renderCart();
    });
  }

  // initial render
  currentPage = 1;
  renderProducts();
  renderCart();

  // close detail on escape
  document.addEventListener('keydown', (e)=> {
    if(e.key==='Escape'){
      if(!detailPanel.classList.contains('hidden')){
        detailPanel.classList.remove('open');
        setTimeout(()=> detailPanel.classList.add('hidden'),280);
      }
    }
  });

  // Checkout button → go to checkout.html
  if (checkoutBtn) {
    checkoutBtn.addEventListener('click', function () {
      if (!cart || Object.keys(cart).length === 0) {
        alert('Your cart is empty.');
        return;
      }
      window.location.href = 'checkout.html';
    });
  }

  // Clear cart button
  if (clearCartBtn) {
    clearCartBtn.addEventListener('click', function () {
      if (!confirm('Clear your cart?')) return;
      cart = {};
      localStorage.setItem('gon_cart', JSON.stringify({}));
      renderCart();
    });
  }
  </script>

  <!-- WhatsApp Floating Chat Button -->
  <a href="https://wa.me/917827491801?text=Hi%20Gems%20of%20Nature,%20I%20need%20help%20with%20a%20gemstone."
     class="fixed bottom-20 right-6 bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-full shadow-lg flex items-center gap-2 text-sm font-semibold transition-all z-50"
     target="_blank" rel="noopener">
    <img src="images/social/whatsapp.png" class="w-6 h-6" alt="WhatsApp">
    Chat with Us
  </a>

  <!-- Global config & utils -->
  <script src="js/gn-config.js"></script>
  <script src="js/gn-utils.js"></script>

  <!-- Mobile menu etc. -->
  <script src="js/script.js"></script>
</body>
</html>
