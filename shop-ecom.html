<!doctype html>
<html lang="en">
<head>
  <!-- Google Tag (GA4) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-Y2WZJ6SR5G"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-Y2WZJ6SR5G');
  </script>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="canonical" href="https://www.gemsofnature.shop/shop-ecom.html">

  <!-- Primary SEO Meta Tags -->
  <title>Buy Natural Gemstones Online | Genuine Stones & Secure Checkout | Gems of Nature</title>
  <meta name="description" content="Shop natural certified gemstones online with secure checkout. Transparent pricing, expert guidance, and free consultation. 100% natural stones for astrology, healing & jewellery.">
  <meta name="keywords" content="buy gemstones online India, gemstone checkout, natural gemstones store, premium healing crystals, ecommerce gemstones, secure checkout gemstones">

  <!-- Open Graph / Social Preview -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="Buy Natural Gemstones Online | Secure Checkout & Premium Quality">
  <meta property="og:description" content="Purchase certified natural gemstones with secure online payments, fast shipping and expert support. Perfect stones for astrology and healing.">
  <meta property="og:url" content="https://www.gemsofnature.shop/shop-ecom.html">
  <meta property="og:site_name" content="Gems of Nature">
  <meta property="og:image" content="https://www.gemsofnature.shop/images/banner/og-shop-ecom.jpg">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Buy Natural Gemstones Online | Secure Checkout & Premium Quality">
  <meta name="twitter:description" content="Shop 100% natural gemstones selected by experts for astrology and healing. Secure Razorpay payments & express shipping.">
  <meta name="twitter:image" content="https://www.gemsofnature.shop/images/banner/og-shop-ecom.jpg">
  <meta name="twitter:site" content="@gemsofnature">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="/images/logo.png">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Global Styles -->
  <link rel="stylesheet" href="/css/styles.css">

  <link rel="stylesheet" href="/css/gon-responsive.css">

  <!-- Page Styles -->
  <style>
    .font-montserrat { font-family: 'Montserrat', sans-serif; }

    .fade-in {
      opacity: 0;
      transform: translateY(20px);
      animation: fadeInUp 0.8s ease forwards;
    }
    @keyframes fadeInUp {
      to { opacity: 1; transform: translateY(0); }
    }

    .detail-panel {
      transition: transform .28s ease, opacity .28s ease;
      transform: translateX(20px);
      opacity: 0;
    }
    .detail-panel.open {
      transform: translateX(0);
      opacity: 1;
    }

    .product-card { position: relative; overflow: hidden; }
    .product-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      background: linear-gradient(180deg, rgba(0,0,0,0) 40%, rgba(0,0,0,0.55) 100%);
      color: white;
      padding: 1rem;
      transform: translateY(100%);
      transition: transform .25s ease;
    }
    .product-card:hover .product-overlay,
    .product-card:focus-within .product-overlay {
      transform: translateY(0);
    }

    .line-clamp-3 {
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
    }

    .muted { color:#6b7280; font-size:0.95rem; }

    /* Filter pills */
    .filter-pill {
      border: 1px solid #d1d5db;
      border-radius: 999px;
      padding: 0.4rem 0.95rem;
      background: #ffffff;
      font-size: 0.8rem;
      cursor: pointer;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      transition: background 0.15s ease, border-color 0.15s ease, color 0.15s ease;
    }
    .filter-pill span.arrow {
      font-size: 0.6rem;
      line-height: 1;
    }
    .filter-pill:hover {
      background: #181d1c;
      border-color: #2b3431;
      color: #ffffff;
    }
    .filter-pill.active {
      background: #191f1e;
      border-color: #131a18;
      color: #ffffff;
    }
  </style>

  <!-- Shared layout (header/footer) -->
  <script src="js/layout.js" defer></script>
  <script src="js/ai-chat.js" defer></script>
</head>

<body class="bg-gray-50 text-gray-800 font-montserrat" data-page="shop-ecom">
  <!-- Header injected by layout.js -->
  <div id="header"></div>

  <!-- HERO -->
  <section class="relative bg-cover bg-center h-52 md:h-64 fade-in" style="background-image:url('images/hero-bg.jpg')">
    <div class="absolute inset-0 bg-black/45 flex items-center justify-center">
      <div class="text-center text-white px-6">
        <h1 class="text-2xl md:text-4xl font-bold">Shop & Buy — Gems of Nature</h1>
        <p class="mt-2">Authentic gemstones for healing, jewellery & collectors.</p>
      </div>
    </div>
  </section>

  <!-- MAIN -->
  <main class="container mx-auto px-4 py-10 fade-in">
    <!-- Filters block -->
    <div class="bg-white rounded-2xl shadow p-4 mb-6 flex flex-col gap-3">
      <!-- Row 1: search (left) + sort + currency (right) -->
      <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
        <div class="flex-1">
          <input
            id="search-input"
            type="search"
            placeholder="Search gemstones, crystals or Rudraksha"
            class="border rounded-full px-4 py-2 w-full text-sm"
          />
        </div>

        <div class="flex flex-col sm:flex-row sm:items-center gap-3 md:justify-end">
          <select id="sort-select" class="border rounded-full px-3 py-2 text-sm w-full sm:w-auto">
            <option value="default">Sort: Featured</option>
            <option value="price-asc">Price: Low → High</option>
            <option value="price-desc">Price: High → Low</option>
            <option value="name">A–Z</option>
          </select>

          <div class="flex items-center gap-2 justify-between sm:justify-start">
            <span class="text-sm text-gray-600">Currency</span>
            <select id="currency-select" class="border rounded-full px-3 py-2 text-sm">
              <option value="INR">₹ INR</option>
              <option value="USD">$ USD</option>
              <option value="EUR">€ EUR</option>
              <option value="GBP">£ GBP</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Hidden category select (used by JS) -->
      <select id="category-filter" class="hidden">
        <option value="all">All categories</option>
        <option value="Precious">Precious</option>
        <option value="Opal">Opal</option>
        <option value="Astrology">Astrology</option>
        <option value="Healing">Healing</option>
        <option value="Accessory">Healing Accessories</option>
        <option value="Rudraksha">Rudraksha</option>
        <option value="Raw">Raw Stones</option>
      </select>

      <!-- Row 2: pill filters -->
      <div class="flex flex-wrap gap-2 pt-1">
        <button class="filter-pill active" type="button" data-category="all">
          All categories <span class="arrow text-gray-300">&#9662;</span>
        </button>
        <button class="filter-pill" type="button" data-filter="price">
          Price <span class="arrow text-gray-300">&#9662;</span>
        </button>
        <button class="filter-pill" type="button" data-filter="price-per-carat">
          Price per Carat <span class="arrow text-gray-300">&#9662;</span>
        </button>
        <button class="filter-pill" type="button" data-filter="weight-carat">
          Weight (Carat) <span class="arrow">&#9662;</span>
        </button>
        <button class="filter-pill" type="button" data-filter="weight-ratti">
          Weight (Ratti) <span class="arrow text-gray-300">&#9662;</span>
        </button>
        <button class="filter-pill" type="button" data-filter="certification">
          Certification <span class="arrow text-gray-300">&#9662;</span>
        </button>
        <button class="filter-pill" type="button" data-filter="origin">
          Origin <span class="arrow text-gray-300">&#9662;</span>
        </button>
      </div>

      <!-- Filter dropdown panel -->
      <div
        id="filter-panel"
        class="mt-3 hidden bg-white border border-gray-200 rounded-2xl shadow-lg p-4 text-sm"
      ></div>
    </div>

    <!-- Products grid -->
    <div id="products-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>

    <!-- pagination -->
    <div id="pagination" class="mt-6 flex items-center justify-center gap-2"></div>
  </main>

  <!-- PRODUCT DETAIL (slide-in) -->
  <aside
    id="product-detail"
    class="fixed right-4 top-12 w-full md:w-1/2 bg-white rounded-2xl shadow-lg p-6 detail-panel z-50 hidden"
    aria-hidden="true"
  >
    <div class="flex gap-4">
      <img id="detail-image" src="images/placeholder.jpg" alt="" class="w-40 h-40 object-cover rounded" />
      <div class="flex-1">
        <div class="flex items-start justify-between">
          <h3 id="detail-title" class="text-xl font-semibold text-gray-700"></h3>
          <button id="close-detail" class="text-gray-500">✕</button>
        </div>
        <div id="detail-meta" class="text-sm text-gray-600 mt-2"></div>
        <div id="detail-desc" class="text-sm text-gray-700 mt-3"></div>
        <div id="detail-mukhi" class="mt-3 text-sm text-gray-700"></div>
        <div id="detail-deity" class="mt-1 text-sm text-gray-700"></div>
        <div id="detail-mantra" class="mt-1 text-sm text-gray-700"></div>
        <div class="mt-4 flex items-center gap-3">
          <div id="detail-price" class="text-lg font-semibold text-gray-800"></div>
          <button id="detail-add" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg">
            Add to Cart
          </button>
        </div>
      </div>
    </div>
  </aside>

  <!-- Footer -->
  <div id="footer"></div>

  <!-- Product data -->
  <script src="js/products.js?v=4"></script>
  <!-- Extra spiritual meta -->
  <script src="js/product-meta.js"></script>

  <!-- Ecommerce logic -->
  <script>
  // Use products from window
  const products = window.products || [];

  // compute a display price (midpoint) for each product if not present
  products.forEach(p => {
    if (!p.price) p.price = Math.round(((p.price_min || 0) + (p.price_max || 0)) / 2);
  });

  const ITEMS_PER_PAGE = 12;
  let currentPage = 1;
  let currentCurrency = 'INR';
  const currencyRates = { INR:1, USD:1/83, EUR:1/95, GBP:1/110 };
  let cart = JSON.parse(localStorage.getItem('gon_cart') || '{}');
  const SHIPPING = 50;

  // extra filter state for pills
  const filterState = {
    priceMin: null,
    priceMax: null,
    ppcMin: null,
    ppcMax: null,
    wtMin: null,
    wtMax: null,
    rattiMin: null,
    rattiMax: null,
    certs: [],
    origins: []
  };

  // precompute unique certifications & origins (if present in data)
  const uniqueCerts = [...new Set(products.map(p => p.certification).filter(Boolean))];
  const uniqueOrigins = [...new Set(products.map(p => p.origin).filter(Boolean))];

  function formatCurrency(value, currency='INR'){
    if (value==null) return '';
    if (currency==='INR') return '₹' + Number(value).toLocaleString('en-IN');
    const symbol = currency==='USD' ? '$' : currency==='EUR' ? '€' : '£';
    return symbol + (value * currencyRates[currency]).toFixed(2);
  }

  function getProductPrice(prod) {
    if (!prod) return 0;
    if (typeof prod.price === 'number') return prod.price;
    if (typeof prod.price_min === 'number') return prod.price_min;
    if (typeof prod.price_max === 'number') return prod.price_max;
    const raw = String(prod.price || prod.price_min || prod.price_max || '');
    const num = parseFloat(raw.replace(/[^0-9.-]/g, ''));
    return isNaN(num) ? 0 : num;
  }

  function renderProductCard(p){
    const div = document.createElement('div');
    div.className = 'bg-white rounded-2xl shadow-md product-card';
    div.setAttribute('data-id', p.id);
    div.innerHTML = `
      <div class="relative h-48">
        <img src="${p.image}" onerror="this.src='images/placeholder.jpg'" alt="${p.name}" class="w-full h-full object-cover transition-transform duration-500" />
        <div class="product-overlay">
          <div class="w-full text-sm text-white line-clamp-3">${p.description || ''}</div>
        </div>
      </div>
      <div class="p-4">
        <h4 class="text-md font-semibold text-gray-700">${p.name}</h4>
        <div class="text-xs text-gray-600">${p.category || ''}</div>
        <div class="mt-3 flex items-center justify-between">
          <div class="font-semibold text-gray-800">${formatCurrency(getProductPrice(p), currentCurrency)}</div>
          <div class="flex items-center gap-2">
            <button class="view-detail bg-white border border-gray-200 text-gray-700 px-3 py-2 rounded-lg" data-id="${p.id}">View</button>
            <button
              class="add-to-cart bg-gray-600 hover:bg-gray-700 text-white px-3 py-2 rounded-lg"
              data-id="${p.id}"
            >
              Add
            </button>
          </div>
        </div>
      </div>
    `;
    return div;
  }

  function applyFilters(){
    const q = (document.getElementById('search-input').value || '').toLowerCase();
    const catSelect = document.getElementById('category-filter');
    const cat = catSelect ? catSelect.value : 'all';
    const sort = document.getElementById('sort-select').value;

    let out = products.filter(p => {
      // category
      if (cat !== 'all' && p.category !== cat) return false;

      // search text
      if (q && !(p.name.toLowerCase().includes(q) ||
                 (p.description || '').toLowerCase().includes(q) ||
                 (p.category || '').toLowerCase().includes(q))) return false;

      // numeric filters
      const price = getProductPrice(p);
      if (filterState.priceMin != null && price < filterState.priceMin) return false;
      if (filterState.priceMax != null && price > filterState.priceMax) return false;

      const ppc = p.price_per_carat || p.ppc;
      if (filterState.ppcMin != null && (ppc == null || ppc < filterState.ppcMin)) return false;
      if (filterState.ppcMax != null && (ppc == null || ppc > filterState.ppcMax)) return false;

      const wt = p.weight_carat || p.carat || p.weight;
      if (filterState.wtMin != null && (wt == null || wt < filterState.wtMin)) return false;
      if (filterState.wtMax != null && (wt == null || wt > filterState.wtMax)) return false;

      const rt = p.weight_ratti || p.ratti;
      if (filterState.rattiMin != null && (rt == null || rt < filterState.rattiMin)) return false;
      if (filterState.rattiMax != null && (rt == null || rt > filterState.rattiMax)) return false;

      // certification
      if (filterState.certs.length) {
        const certVal = p.certification ? String(p.certification) : '';
        if (!filterState.certs.includes(certVal)) return false;
      }

      // origin
      if (filterState.origins.length) {
        const originVal = p.origin ? String(p.origin) : '';
        if (!filterState.origins.includes(originVal)) return false;
      }

      return true;
    });

    if (sort === 'price-asc') out.sort((a, b) => getProductPrice(a) - getProductPrice(b));
    if (sort === 'price-desc') out.sort((a, b) => getProductPrice(b) - getProductPrice(a));
    if (sort === 'name') out.sort((a, b) => (a.name || '').localeCompare(b.name || ''));

    return out;
  }

  function renderPagination(pages){
    const el = document.getElementById('pagination');
    el.innerHTML = '';
    if (pages <= 1) return;
    for(let i=1;i<=pages;i++){
      const btn = document.createElement('button');
      btn.className = `px-3 py-1 rounded ${i===currentPage ? 'bg-gray-600 text-white' : 'bg-white border'}`;
      btn.textContent = i;
      btn.onclick = () => {
        currentPage = i;
        renderProducts();
        window.scrollTo({top: 200, behavior:'smooth'});
      };
      el.appendChild(btn);
    }
  }

  function renderProducts(){
    const grid = document.getElementById('products-grid');
    grid.innerHTML = '';
    const filtered = applyFilters();
    const start = (currentPage-1)*ITEMS_PER_PAGE;
    const pageItems = filtered.slice(start, start+ITEMS_PER_PAGE);
    pageItems.forEach(p => grid.appendChild(renderProductCard(p)));
    renderPagination(Math.ceil(filtered.length/ITEMS_PER_PAGE));
  }

  // ---------- Filter pill dropdown logic ----------
  const filterPanel = document.getElementById('filter-panel');
  const filterPills = document.querySelectorAll('.filter-pill');

  filterPills.forEach(pill => {
    pill.addEventListener('click', () => {
      if (!filterPanel) return;

      const type = pill.dataset.filter || pill.dataset.category || '';

      // toggle same panel (close if already open)
      if (!filterPanel.classList.contains('hidden') && filterPanel.dataset.type === type) {
        filterPanel.classList.add('hidden');
        return;
      }

      filterPanel.dataset.type = type;
      renderFilterPanel(type);
      filterPanel.classList.remove('hidden');
    });
  });

  function renderFilterPanel(type) {
    if (!filterPanel) return;
    const catSelect = document.getElementById('category-filter');

    // category
    if (type === 'all' || type === 'category') {
      filterPanel.innerHTML = `
        <div class="grid grid-cols-2 gap-2">
          <button class="cat-option border rounded-lg px-3 py-1 text-left text-sm" data-value="all">All categories</button>
          <button class="cat-option border rounded-lg px-3 py-1 text-left text-sm" data-value="Precious">Precious</button>
          <button class="cat-option border rounded-lg px-3 py-1 text-left text-sm" data-value="Opal">Opal</button>
          <button class="cat-option border rounded-lg px-3 py-1 text-left text-sm" data-value="Astrology">Astrology</button>
          <button class="cat-option border rounded-lg px-3 py-1 text-left text-sm" data-value="Healing">Healing</button>
          <button class="cat-option border rounded-lg px-3 py-1 text-left text-sm" data-value="Accessory">Accessories</button>
          <button class="cat-option border rounded-lg px-3 py-1 text-left text-sm" data-value="Rudraksha">Rudraksha</button>
          <button class="cat-option border rounded-lg px-3 py-1 text-left text-sm" data-value="Raw">Raw stones</button>
        </div>
      `;

      filterPanel.querySelectorAll('.cat-option').forEach(btn => {
        btn.onclick = () => {
          const value = btn.dataset.value;
          if (catSelect) catSelect.value = value;

          const catPill = document.querySelector('.filter-pill[data-category]');
          if (catPill) {
            const label = value === 'all' ? 'All categories' : btn.textContent;
            catPill.innerHTML = label + ' <span class="arrow text-gray-300">&#9662;</span>';
          }

          currentPage = 1;
          renderProducts();
          filterPanel.classList.add('hidden');
        };
      });

      return;
    }

    // helper to build numeric panel
    function buildNumericPanel(idBase, title, minVal, maxVal) {
      filterPanel.innerHTML = `
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-xs text-gray-500">Min</label>
            <input id="${idBase}-min" type="number"
                   class="mt-1 w-full border rounded-lg px-2 py-1 text-sm"
                   value="${minVal ?? ''}" />
          </div>
          <div>
            <label class="text-xs text-gray-500">Max</label>
            <input id="${idBase}-max" type="number"
                   class="mt-1 w-full border rounded-lg px-2 py-1 text-sm"
                   value="${maxVal ?? ''}" />
          </div>
        </div>
        <div class="mt-3 flex justify-end gap-2">
          <button id="${idBase}-clear" class="px-3 py-1 border rounded-lg text-xs">Clear</button>
          <button id="${idBase}-apply" class="px-3 py-1 bg-gray-600 text-white rounded-lg text-xs">Apply</button>
        </div>
      `;
    }

    // build panels by type
    if (type === 'price') {
      buildNumericPanel('filter-price', 'Price', filterState.priceMin, filterState.priceMax);

      const minInput = document.getElementById('filter-price-min');
      const maxInput = document.getElementById('filter-price-max');
      document.getElementById('filter-price-apply').onclick = () => {
        filterState.priceMin = minInput.value ? Number(minInput.value) : null;
        filterState.priceMax = maxInput.value ? Number(maxInput.value) : null;
        currentPage = 1;
        renderProducts();
        filterPanel.classList.add('hidden');
      };
      document.getElementById('filter-price-clear').onclick = () => {
        filterState.priceMin = null;
        filterState.priceMax = null;
        minInput.value = '';
        maxInput.value = '';
        currentPage = 1;
        renderProducts();
        filterPanel.classList.add('hidden');
      };
      return;
    }

    if (type === 'price-per-carat') {
      buildNumericPanel('filter-ppc', 'Price per Carat', filterState.ppcMin, filterState.ppcMax);

      const minInput = document.getElementById('filter-ppc-min');
      const maxInput = document.getElementById('filter-ppc-max');
      document.getElementById('filter-ppc-apply').onclick = () => {
        filterState.ppcMin = minInput.value ? Number(minInput.value) : null;
        filterState.ppcMax = maxInput.value ? Number(maxInput.value) : null;
        currentPage = 1;
        renderProducts();
        filterPanel.classList.add('hidden');
      };
      document.getElementById('filter-ppc-clear').onclick = () => {
        filterState.ppcMin = null;
        filterState.ppcMax = null;
        minInput.value = '';
        maxInput.value = '';
        currentPage = 1;
        renderProducts();
        filterPanel.classList.add('hidden');
      };
      return;
    }

    if (type === 'weight-carat') {
      buildNumericPanel('filter-wt', 'Weight (Carat)', filterState.wtMin, filterState.wtMax);

      const minInput = document.getElementById('filter-wt-min');
      const maxInput = document.getElementById('filter-wt-max');
      document.getElementById('filter-wt-apply').onclick = () => {
        filterState.wtMin = minInput.value ? Number(minInput.value) : null;
        filterState.wtMax = maxInput.value ? Number(maxInput.value) : null;
        currentPage = 1;
        renderProducts();
        filterPanel.classList.add('hidden');
      };
      document.getElementById('filter-wt-clear').onclick = () => {
        filterState.wtMin = null;
        filterState.wtMax = null;
        minInput.value = '';
        maxInput.value = '';
        currentPage = 1;
        renderProducts();
        filterPanel.classList.add('hidden');
      };
      return;
    }

    if (type === 'weight-ratti') {
      buildNumericPanel('filter-ratti', 'Weight (Ratti)', filterState.rattiMin, filterState.rattiMax);

      const minInput = document.getElementById('filter-ratti-min');
      const maxInput = document.getElementById('filter-ratti-max');
      document.getElementById('filter-ratti-apply').onclick = () => {
        filterState.rattiMin = minInput.value ? Number(minInput.value) : null;
        filterState.rattiMax = maxInput.value ? Number(maxInput.value) : null;
        currentPage = 1;
        renderProducts();
        filterPanel.classList.add('hidden');
      };
      document.getElementById('filter-ratti-clear').onclick = () => {
        filterState.rattiMin = null;
        filterState.rattiMax = null;
        minInput.value = '';
        maxInput.value = '';
        currentPage = 1;
        renderProducts();
        filterPanel.classList.add('hidden');
      };
      return;
    }

    if (type === 'certification') {
      if (!uniqueCerts.length) {
        filterPanel.innerHTML = '<p class="text-xs text-gray-500">No certification data available.</p>';
        return;
      }

      filterPanel.innerHTML = `
        <div class="space-y-2 max-h-60 overflow-auto">
          ${uniqueCerts.map(c => `
            <label class="flex items-center gap-2 text-sm">
              <input type="checkbox" class="cert-checkbox"
                     value="${c}"
                     ${filterState.certs.includes(String(c)) ? 'checked' : ''} />
              <span>${c}</span>
            </label>
          `).join('')}
        </div>
        <div class="mt-3 flex justify-end gap-2">
          <button id="filter-cert-clear" class="px-3 py-1 border rounded-lg text-xs">Clear</button>
          <button id="filter-cert-apply" class="px-3 py-1 bg-gray-600 text-white rounded-lg text-xs">Apply</button>
        </div>
      `;

      document.getElementById('filter-cert-apply').onclick = () => {
        const checks = filterPanel.querySelectorAll('.cert-checkbox');
        filterState.certs = Array.from(checks)
          .filter(ch => ch.checked)
          .map(ch => String(ch.value));
        currentPage = 1;
        renderProducts();
        filterPanel.classList.add('hidden');
      };
      document.getElementById('filter-cert-clear').onclick = () => {
        filterState.certs = [];
        currentPage = 1;
        renderProducts();
        filterPanel.classList.add('hidden');
      };
      return;
    }

    if (type === 'origin') {
      if (!uniqueOrigins.length) {
        filterPanel.innerHTML = '<p class="text-xs text-gray-500">No origin data available.</p>';
        return;
      }

      filterPanel.innerHTML = `
        <div class="space-y-2 max-h-60 overflow-auto">
          ${uniqueOrigins.map(o => `
            <label class="flex items-center gap-2 text-sm">
              <input type="checkbox" class="origin-checkbox"
                     value="${o}"
                     ${filterState.origins.includes(String(o)) ? 'checked' : ''} />
              <span>${o}</span>
            </label>
          `).join('')}
        </div>
        <div class="mt-3 flex justify-end gap-2">
          <button id="filter-origin-clear" class="px-3 py-1 border rounded-lg text-xs">Clear</button>
          <button id="filter-origin-apply" class="px-3 py-1 bg-gray-600 text-white rounded-lg text-xs">Apply</button>
        </div>
      `;

      document.getElementById('filter-origin-apply').onclick = () => {
        const checks = filterPanel.querySelectorAll('.origin-checkbox');
        filterState.origins = Array.from(checks)
          .filter(ch => ch.checked)
          .map(ch => String(ch.value));
        currentPage = 1;
        renderProducts();
        filterPanel.classList.add('hidden');
      };
      document.getElementById('filter-origin-clear').onclick = () => {
        filterState.origins = [];
        currentPage = 1;
        renderProducts();
        filterPanel.classList.add('hidden');
      };
      return;
    }

    // fallback
    filterPanel.innerHTML = `
      <p class="text-xs text-gray-500 mb-1">Filter coming soon.</p>
    `;
  }

  // product card interactions
  document.getElementById('products-grid').addEventListener('click',(e)=>{
    if (e.target.closest('.add-to-cart')){
      const id = e.target.closest('[data-id]').getAttribute('data-id');
      cart[id] = (cart[id]||0)+1;
      saveCart();
      e.target.textContent = 'Added';
      setTimeout(()=> e.target.textContent='Add',800);
    } else if (e.target.closest('.view-detail')){
      const id = e.target.closest('[data-id]').getAttribute('data-id');
      openProductDetail(id);
    } else {
      const card = e.target.closest('[data-id]');
      if (card) openProductDetail(card.getAttribute('data-id'));
    }
  });

  // detail panel
  const detailPanel = document.getElementById('product-detail');
  const detailImage = document.getElementById('detail-image');
  const detailTitle = document.getElementById('detail-title');
  const detailMeta = document.getElementById('detail-meta');
  const detailDesc = document.getElementById('detail-desc');
  const detailMukhi = document.getElementById('detail-mukhi');
  const detailDeity = document.getElementById('detail-deity');
  const detailMantra = document.getElementById('detail-mantra');
  const detailPrice = document.getElementById('detail-price');
  const detailAdd = document.getElementById('detail-add');

  function openProductDetail(id){
    const p = products.find(x => String(x.id) === String(id));
    if(!p) return;
    detailImage.src = p.image || 'images/placeholder.jpg';
    detailTitle.textContent = p.name;
    detailMeta.textContent = p.category || '';
    detailDesc.textContent = p.description || '';
    detailMukhi.textContent = p.mukhi ? ('Mukhi: ' + p.mukhi) : '';
    detailDeity.textContent = p.deity ? ('Deity: ' + p.deity) : '';
    detailMantra.textContent = p.mantra ? ('Mantra: ' + p.mantra) : '';
    detailPrice.textContent = formatCurrency(getProductPrice(p), currentCurrency);
    detailAdd.dataset.id = p.id;
    detailPanel.classList.remove('hidden');
    setTimeout(()=> detailPanel.classList.add('open'),10);
    detailPanel.setAttribute('aria-hidden','false');
  }

  document.getElementById('close-detail').addEventListener('click', ()=>{
    detailPanel.classList.remove('open');
    setTimeout(()=> detailPanel.classList.add('hidden'),280);
  });

  detailAdd && detailAdd.addEventListener('click', ()=>{
    const id = detailAdd.dataset.id;
    cart[id] = (cart[id]||0)+1;
    saveCart();
    detailAdd.textContent='Added';
    setTimeout(()=> detailAdd.textContent='Add to Cart',900);
  });

  // header cart badge & mini cart
  function updateHeaderCartCount(count) {
    const badge = document.getElementById('cartCount'); // badge in header.html
    if (!badge) return;
    badge.textContent = String(count);
  }

  function saveCart(){
    localStorage.setItem('gon_cart', JSON.stringify(cart));
    renderCart();
  }

  function renderCart(){
    // always grab latest elements (header loads asynchronously)
    const cartMiniItemsEl = document.getElementById('cart-items-mini');
    const cartTotalMiniEl = document.getElementById('cart-total-mini');
    const clearCartMiniBtn = document.getElementById('clear-cart-mini');

    const entries = Object.entries(cart || {});
    let subtotal = 0;

    // reset mini-cart list
    if (cartMiniItemsEl) {
      cartMiniItemsEl.innerHTML = '';
    }

    if (entries.length === 0) {
      if (cartMiniItemsEl) {
        cartMiniItemsEl.innerHTML = '<p class="text-sm text-gray-600">Your cart is empty.</p>';
      }
      if (cartTotalMiniEl) cartTotalMiniEl.textContent = '₹0';
      updateHeaderCartCount(0);
      return;
    }

    // there ARE items
    entries.forEach(([pid, qty]) => {
      const prod =
        products.find(p => String(p.id) === String(pid)) ||
        { name: pid, price: 0, image: 'images/placeholder.jpg' };

      const price = getProductPrice(prod);
      subtotal += price * qty;

      if (cartMiniItemsEl) {
        const item = document.createElement('div');
        item.className = 'flex items-center justify-between gap-2 py-1 border-b border-gray-100 last:border-b-0';
        item.innerHTML = `
          <div class="flex-1">
            <div class="text-xs font-medium text-gray-800">${prod.name || pid}</div>
            <div class="text-[11px] text-gray-500">${qty} × ${formatCurrency(price, currentCurrency)}</div>
          </div>
          <div class="text-xs font-semibold text-gray-800">
            ${formatCurrency(price * qty, currentCurrency)}
          </div>
        `;
        cartMiniItemsEl.appendChild(item);
      }
    });

    const count = entries.reduce((s, [, q]) => s + Number(q || 0), 0);
    updateHeaderCartCount(count);

    const total = subtotal + SHIPPING;
    if (cartTotalMiniEl) {
      cartTotalMiniEl.textContent = formatCurrency(total, currentCurrency);
    }

    // wire up "Clear Cart" button once header exists
    if (clearCartMiniBtn && !clearCartMiniBtn.dataset.bound) {
      clearCartMiniBtn.dataset.bound = '1';
      clearCartMiniBtn.addEventListener('click', function () {
        if (!confirm('Clear your cart?')) return;
        cart = {};
        localStorage.setItem('gon_cart', JSON.stringify({}));
        renderCart();
      });
    }
  }

  // search / filter events
  ['search-input','sort-select'].forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    const eventType = id === 'sort-select' ? 'change' : 'input';
    el.addEventListener(eventType, () => {
      currentPage = 1;
      renderProducts();
    });
  });

  // currency change
  const currencySelectEl = document.getElementById('currency-select');
  if (currencySelectEl) {
    currencySelectEl.addEventListener('change', (e) => {
      currentCurrency = e.target.value;
      renderProducts();
      renderCart();
    });
  }

  // initial render
  currentPage = 1;
  renderProducts();
  renderCart();

  // If coming from shop.html with ?id=pX → open product detail
  const params = new URLSearchParams(window.location.search);
  const initialId = params.get('id');
  if (initialId) {
    const exists = products.find(p => String(p.id) === String(initialId));
    if (exists) {
      setTimeout(() => openProductDetail(initialId), 300);
    }
  }

  // close detail on Escape
  document.addEventListener('keydown', (e)=> {
    if(e.key === 'Escape'){
      if(!detailPanel.classList.contains('hidden')){
        detailPanel.classList.remove('open');
        setTimeout(()=> detailPanel.classList.add('hidden'),280);
      }
    }
  });
  </script>

  <!-- WhatsApp Floating Chat Button -->
  <a href="https://wa.me/917827491801?text=Hi%20Gems%20of%20Nature,%20I%20need%20help%20with%20a%20gemstone."
     class="fixed bottom-5 right-6 bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-full shadow-lg flex items-center gap-2 text-sm font-semibold transition-all z-50"
     target="_blank" rel="noopener">
    <img src="images/social/whatsapp.png" class="w-6 h-6" alt="WhatsApp">
    Chat with Us
  </a>

  <!-- Global config & utils -->
  <script src="js/gn-config.js"></script>
  <script src="js/gn-utils.js"></script>
  <script src="js/script.js"></script>
</body>
</html>
